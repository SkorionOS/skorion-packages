From bf5171739a97b15ce899ffe382eeefc6888b92f5 Mon Sep 17 00:00:00 2001
From: honjow <honjow311@gmail.com>
Date: Tue, 2 Sep 2025 00:06:00 +0800
Subject: [PATCH 3/3] fix: prevent clipboard content loss during runtime

---
 src/sync.rs | 19 ++++++++++++++++---
 1 file changed, 16 insertions(+), 3 deletions(-)

diff --git a/src/sync.rs b/src/sync.rs
index b70d256..f43d926 100644
--- a/src/sync.rs
+++ b/src/sync.rs
@@ -65,6 +65,19 @@ pub fn keep_synced(clipboards: &Vec<Box<dyn Clipboard>>) -> MyResult<()> {
     loop {
         sleep(Duration::from_millis(100));
         let new_value = await_change(clipboards)?;
+        
+        // Smart sync: don't sync empty content if any clipboard still has non-empty content
+        if new_value.is_empty() {
+            let has_non_empty_content = clipboards.iter().any(|c| {
+                !c.get().unwrap_or_default().is_empty()
+            });
+            
+            if has_non_empty_content {
+                log::debug!("Skipping sync of empty content - other clipboards have content");
+                continue;
+            }
+        }
+        
         for c in clipboards {
             c.set(&new_value)?;
         }
@@ -254,12 +267,12 @@ fn await_change(clipboards: &Vec<Box<dyn Clipboard>>) -> MyResult<String> {
             }
             let new = c.get()?;
             if new != start {
-                // Smart handling of X11 clear: only sync empty content when other clipboards are also empty
-                if c.display() == ":0" && new.is_empty() && !start.is_empty() {
+                // Smart handling of X11 clear: ignore X11 empty if other clipboards have any content
+                if c.display() == ":0" && new.is_empty() {
                     // Check if there are other non-empty clipboards
                     let has_non_empty = clipboards.iter().any(|other| {
                         other.display() != ":0" && 
-                        other.get().unwrap_or_default() == start
+                        !other.get().unwrap_or_default().is_empty()
                     });
                     
                     if has_non_empty {
-- 
2.51.0

