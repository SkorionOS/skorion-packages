From fc34438066e8675d433265c842aab32a659e915a Mon Sep 17 00:00:00 2001
From: honjow <honjow311@gmail.com>
Date: Mon, 1 Sep 2025 05:24:10 +0800
Subject: [PATCH 2/3] fix: prevent X11 clipboard clearing in Hyprland
 environment

- Add smart handling to ignore X11 clipboard clear when other clipboards have content
- Prevent clipboard content loss during program startup in Hyprland
- Add logging debounce to avoid log spam
- Maintain bidirectional clipboard sync functionality
---
 src/sync.rs | 19 +++++++++++++++++++
 1 file changed, 19 insertions(+)

diff --git a/src/sync.rs b/src/sync.rs
index 387b6fc..b70d256 100644
--- a/src/sync.rs
+++ b/src/sync.rs
@@ -245,6 +245,8 @@ fn get_x11(n: u8) -> MyResult<Option<Box<dyn Clipboard>>> {
 
 fn await_change(clipboards: &Vec<Box<dyn Clipboard>>) -> MyResult<String> {
     let start = clipboards[0].get()?;
+    let mut x11_ignore_logged = false; // Only log once
+    
     loop {
         for c in clipboards {
             if !c.should_poll() {
@@ -252,6 +254,23 @@ fn await_change(clipboards: &Vec<Box<dyn Clipboard>>) -> MyResult<String> {
             }
             let new = c.get()?;
             if new != start {
+                // Smart handling of X11 clear: only sync empty content when other clipboards are also empty
+                if c.display() == ":0" && new.is_empty() && !start.is_empty() {
+                    // Check if there are other non-empty clipboards
+                    let has_non_empty = clipboards.iter().any(|other| {
+                        other.display() != ":0" && 
+                        other.get().unwrap_or_default() == start
+                    });
+                    
+                    if has_non_empty {
+                        if !x11_ignore_logged {
+                            log::debug!("Ignoring X11 clear - other clipboards still have content");
+                            x11_ignore_logged = true;
+                        }
+                        continue;
+                    }
+                }
+                
                 log::info!("clipboard updated from display {}", c.display());
                 log::sensitive!(log::info, "clipboard contents: '{}'", new);
                 return Ok(new);
-- 
2.51.0

