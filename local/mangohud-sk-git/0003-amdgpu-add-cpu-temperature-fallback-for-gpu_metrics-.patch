From 06c7dacdfba1f5e8523e0df7da87e25ef7a20124 Mon Sep 17 00:00:00 2001
From: honjow <honjow311@gmail.com>
Date: Sun, 22 Feb 2026 09:36:55 +0800
Subject: [PATCH 3/4] amdgpu: add cpu temperature fallback for gpu_metrics v3

When temperature_core is zero or invalid, fall back to hwmon or
temperature_soc as CPU temperature source.
---
 src/amdgpu.cpp | 21 ++++++++++++++++++---
 1 file changed, 18 insertions(+), 3 deletions(-)

diff --git a/src/amdgpu.cpp b/src/amdgpu.cpp
index 9a9a261..c18475a 100644
--- a/src/amdgpu.cpp
+++ b/src/amdgpu.cpp
@@ -163,7 +163,22 @@ void AMDGPU::get_instant_metrics(struct amdgpu_common_metrics *metrics) {
 
 			cpu_temp = MAX(cpu_temp, amdgpu_metrics->temperature_core[i]);
 		}
-		metrics->apu_cpu_temp_c = cpu_temp / 100;
+
+		// Fallback: if temperature_core is 0 or invalid, try hwmon or use temperature_soc
+		if (cpu_temp == 0) {
+			int hwmon_temp = 0;
+			if (cpuStats.ReadcpuTempFile(hwmon_temp) && hwmon_temp > 0) {
+				// Use hwmon temperature (already in Celsius)
+				metrics->apu_cpu_temp_c = hwmon_temp;
+			} else if (IS_VALID_METRIC(amdgpu_metrics->temperature_soc) && amdgpu_metrics->temperature_soc > 0) {
+				// Use SoC temperature as approximation
+				metrics->apu_cpu_temp_c = amdgpu_metrics->temperature_soc / 100;
+			} else {
+				metrics->apu_cpu_temp_c = 0;
+			}
+		} else {
+			metrics->apu_cpu_temp_c = cpu_temp / 100;
+		}
 
 		metrics->gpu_load_percent = amdgpu_metrics->average_gfx_activity;
 		// average_apu_power includes gfx_power so remove that from cpu_power
@@ -174,7 +189,7 @@ void AMDGPU::get_instant_metrics(struct amdgpu_common_metrics *metrics) {
 		metrics->average_gfx_power_w = amdgpu_metrics->average_gfx_power / 1000.0;
 		metrics->current_gfxclk_mhz = amdgpu_metrics->average_gfxclk_frequency;
 		metrics->current_uclk_mhz = amdgpu_metrics->average_uclk_frequency;
-		
+
 		if (previous_metrics.common_header.structure_size == 0) {
 			previous_metrics = *amdgpu_metrics;
 			is_temp = false;
@@ -186,7 +201,7 @@ void AMDGPU::get_instant_metrics(struct amdgpu_common_metrics *metrics) {
 				throttling->v3_power.store(false);
 				throttling->v3_thermal.store(false);
 			}
-			return;	
+			return;
 		} else {
 			uint32_t d_thm_core = V3_THROTTLING_DELTA(thm_core);
 			uint32_t d_thm_gfx  = V3_THROTTLING_DELTA(thm_gfx);
-- 
2.53.0

