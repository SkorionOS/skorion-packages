name: Build Packages

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
    inputs:
      create_snapshot:
        description: 'åˆ›å»ºå¸¦æ—¥æœŸçš„å¿«ç…§ Release'
        required: false
        type: boolean
        default: false

env:
  REPO_NAME: skorion

jobs:
  # ===========================================================================
  # Job 1: æ£€æµ‹æ›´æ–°å¹¶åˆ—å‡ºéœ€è¦æ„å»ºçš„åŒ…
  # ===========================================================================
  list-packages:
    name: Detect Updates
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    outputs:
      aur-packages: ${{ steps.set-aur.outputs.matrix }}
      local-packages: ${{ steps.set-local.outputs.matrix }}
      all-packages: ${{ steps.set-all.outputs.matrix }}
      has-updates: ${{ steps.check-updates.outputs.has-updates }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          # base-devel: åŒ…å« makepkg ç­‰æ„å»ºå·¥å…·
          # git, svn, mercurial, bzr: VCS å·¥å…·ï¼ˆpkgver() å‡½æ•°å¯èƒ½éœ€è¦ï¼‰
          # cargo, rust: Rust é¡¹ç›®çš„ pkgver() å¯èƒ½éœ€è¦
          # jq, curl, tar, findutils, meson: è„šæœ¬ä¾èµ–
          pacman -S --noconfirm base-devel git svn mercurial bzr cargo rust jq curl tar findutils sudo meson
      
      - name: Setup builder user
        run: |
          # åˆ›å»º builder ç”¨æˆ·ï¼ˆmakepkg ä¸å…è®¸ root è¿è¡Œï¼‰
          useradd -m -G wheel builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # ç»™äºˆå·¥ä½œç›®å½•æƒé™
          chown -R builder:builder $GITHUB_WORKSPACE
      
      - name: Check package updates
        id: check-updates
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # ä»¥ builder ç”¨æˆ·è¿è¡Œæ£€æŸ¥è„šæœ¬
          sudo -u builder bash scripts/check-updates.sh
      
      - name: List AUR packages to build
        id: set-aur
        run: |
          if [ -s updated-aur-packages.txt ]; then
            packages=$(cat updated-aur-packages.txt | jq -R -s -c 'split("\n")[:-1]')
          else
            packages="[]"
          fi
          echo "matrix=$packages" >> $GITHUB_OUTPUT
          echo "AUR packages to build: $packages"
      
      - name: List local packages to build
        id: set-local
        run: |
          if [ -s updated-local-packages.txt ]; then
            packages=$(cat updated-local-packages.txt | jq -R -s -c 'split("\n")[:-1]')
          else
            packages="[]"
          fi
          echo "matrix=$packages" >> $GITHUB_OUTPUT
          echo "Local packages to build: $packages"
      
      - name: Merge package lists
        id: set-all
        run: |
          # åˆå¹¶ AUR å’Œæœ¬åœ°åŒ…åˆ—è¡¨ï¼Œæ·»åŠ ç±»å‹æ ‡è®°
          aur_packages='${{ steps.set-aur.outputs.matrix }}'
          local_packages='${{ steps.set-local.outputs.matrix }}'
          
          # ä¸ºæ¯ä¸ªåŒ…æ·»åŠ ç±»å‹å­—æ®µï¼ˆä½¿ç”¨ -c å‹ç¼©æˆå•è¡Œï¼‰
          all_packages=$(jq -nc \
            --argjson aur "$aur_packages" \
            --argjson local "$local_packages" \
            '($aur | map({package: ., type: "aur"})) + ($local | map({package: ., type: "local"}))')
          
          echo "matrix=$all_packages" >> $GITHUB_OUTPUT
          echo "All packages to build: $(echo "$all_packages" | jq -c '.[0:3]')... (total: $(echo "$all_packages" | jq 'length'))"

  # ===========================================================================
  # Job 2: å¹¶è¡Œæ„å»ºæ‰€æœ‰åŒ…ï¼ˆAUR + æœ¬åœ°ï¼‰
  # ===========================================================================
  build-packages:
    needs: list-packages
    name: Build Packages
    runs-on: ubuntu-latest
    if: needs.list-packages.outputs.all-packages != '[]'
    container:
      image: archlinux:latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        include: ${{ fromJson(needs.list-packages.outputs.all-packages) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup build environment
        run: |
          # æ›´æ–°ç³»ç»Ÿ
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo
          
          # åˆ›å»º builder ç”¨æˆ·
          useradd -m -G wheel builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # å®‰è£… pikaur
          sudo -u builder bash -c "
            cd /tmp
            git clone https://aur.archlinux.org/pikaur.git
            cd pikaur
            makepkg -si --noconfirm
          "
          
          chown -R builder:builder $GITHUB_WORKSPACE
      
      - name: Build ${{ matrix.type }} package - ${{ matrix.package }}
        env:
          PACKAGE_NAME: ${{ matrix.package }}
          PACKAGE_TYPE: ${{ matrix.type }}
          OUTPUT_DIR: ${{ github.workspace }}/output
          WORK_DIR: /tmp/build
        run: |
          sudo -u builder bash -c "
            export OUTPUT_DIR='$OUTPUT_DIR'
            export WORK_DIR='$WORK_DIR'
            export GITHUB_WORKSPACE='$GITHUB_WORKSPACE'
            bash $GITHUB_WORKSPACE/scripts/build-single-package.sh '$PACKAGE_NAME' '$PACKAGE_TYPE'
          "
      
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.type }}-${{ matrix.package }}
          path: output/*.pkg.tar.zst
          if-no-files-found: error
          retention-days: 1

  # ===========================================================================
  # Job 3: æ”¶é›†æ‰€æœ‰åŒ…å¹¶ç”Ÿæˆå®Œæ•´ä»“åº“æ•°æ®åº“
  # ===========================================================================
  generate-repo:
    needs: [list-packages, build-packages]
    name: Generate Repository
    runs-on: ubuntu-latest
    if: always() && needs.build-packages.result != 'failure'
    container:
      image: archlinux:latest
    outputs:
      should-publish: ${{ steps.verify-packages.outputs.should-continue }}
      is-snapshot: ${{ steps.check-mode.outputs.is-snapshot }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm pacman-contrib curl jq
      
      - name: Download new build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: aur-*
          merge-multiple: true
          path: output/
        continue-on-error: true
      
      - name: Download local package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: local-*
          merge-multiple: true
          path: output/
        continue-on-error: true
      
      - name: List new packages
        run: |
          echo "==> æ–°æ„å»ºçš„åŒ…:"
          ls -lh output/ || echo "  æ— æ–°åŒ…"
      
      - name: Check build mode
        id: check-mode
        env:
          CREATE_SNAPSHOT: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.create_snapshot) }}
        run: |
          echo "is-snapshot=$CREATE_SNAPSHOT" >> $GITHUB_OUTPUT
          if [ "$CREATE_SNAPSHOT" = "true" ]; then
            echo "==> ğŸ—“ï¸  å¿«ç…§æ¨¡å¼ï¼šå°†åˆ›å»ºå®Œæ•´çš„åŒ…é›†åˆå¿«ç…§"
          else
            echo "==> ğŸ”„ å¢é‡æ¨¡å¼ï¼šä»…æ›´æ–°å˜æ›´çš„åŒ…"
          fi
      
      - name: Download existing data from latest release
        id: download-existing
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          CREATE_SNAPSHOT: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.create_snapshot) }}
        run: |
          echo "==> ä¸‹è½½ latest Release ä¸­çš„ç°æœ‰æ•°æ®"
          
          # ç¡®ä¿ output ç›®å½•å­˜åœ¨
          mkdir -p output
          
          # è·å– latest release ä¿¡æ¯
          LATEST_JSON=$(curl -s "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/tags/latest" || echo "{}")
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          if echo "$LATEST_JSON" | jq -e '.message == "Not Found"' > /dev/null 2>&1; then
            echo "==> é¦–æ¬¡æ„å»ºï¼Œæ— ç°æœ‰æ•°æ®"
            echo "has-existing-data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥ assets æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
          assets_count=$(echo "$LATEST_JSON" | jq '.assets | length // 0')
          if [ "$assets_count" -eq 0 ]; then
            echo "==> latest release å­˜åœ¨ä½†æ²¡æœ‰ assetsï¼Œå¯èƒ½æ˜¯é¦–æ¬¡æ„å»º"
            echo "has-existing-data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has-existing-data=true" >> $GITHUB_OUTPUT
          
          if [ "$CREATE_SNAPSHOT" = "true" ]; then
            # åˆ›å»ºå¿«ç…§ï¼šä¸‹è½½æ‰€æœ‰åŒ…ï¼ˆéœ€è¦å®Œæ•´å‰¯æœ¬ï¼‰
            echo "==> å¿«ç…§æ¨¡å¼ï¼šä¸‹è½½æ‰€æœ‰åŒ…æ–‡ä»¶"
            echo "$LATEST_JSON" | jq -r '.assets[] | select(.name | endswith(".pkg.tar.zst")) | .browser_download_url' | while read url; do
              filename=$(basename "$url")
              
              # è·³è¿‡å·²å­˜åœ¨çš„åŒ…ï¼ˆæ–°æ„å»ºä¼˜å…ˆï¼‰
              if [ -f "output/$filename" ]; then
                echo "  è·³è¿‡ $filename (å·²æœ‰æ–°ç‰ˆæœ¬)"
                continue
              fi
              
              echo "  ä¸‹è½½ $filename"
              curl -sL "$url" -o "output/$filename"
            done
          else
            # æ—¥å¸¸æ›´æ–°ï¼šåªä¸‹è½½æ•°æ®åº“æ–‡ä»¶ï¼ˆå¢é‡æ›´æ–°ï¼‰
            echo "==> å¢é‡æ¨¡å¼ï¼šåªä¸‹è½½æ•°æ®åº“æ–‡ä»¶"
            echo "$LATEST_JSON" | jq -r '.assets[] | select(.name | test("\\.(db|files)")) | .browser_download_url' | while read url; do
              filename=$(basename "$url")
              echo "  ä¸‹è½½ $filename"
              curl -sL "$url" -o "output/$filename"
            done
            
            # ä¸‹è½½ packages.jsonï¼ˆç”¨äºç‰ˆæœ¬æ£€æµ‹ï¼‰
            packages_json_url=$(echo "$LATEST_JSON" | jq -r '.assets[] | select(.name == "packages.json") | .browser_download_url')
            if [ -n "$packages_json_url" ] && [ "$packages_json_url" != "null" ]; then
              echo "  ä¸‹è½½ packages.json"
              curl -sL "$packages_json_url" -o "output/packages.json.old" || true
            fi
          fi
          
          echo "==> å½“å‰æ–‡ä»¶åˆ—è¡¨:"
          ls -lh output/
      
      - name: Verify package files exist
        id: verify-packages
        env:
          HAS_EXISTING_DATA: ${{ steps.download-existing.outputs.has-existing-data }}
          HAS_NEW_BUILDS: ${{ needs.list-packages.outputs.all-packages != '[]' }}
          IS_SNAPSHOT: ${{ steps.check-mode.outputs.is-snapshot }}
        run: |
          pkg_count=$(ls output/*.pkg.tar.zst 2>/dev/null | wc -l)
          
          if [ "$pkg_count" -eq 0 ]; then
            # æ£€æŸ¥æ˜¯å¦æ˜¯çœŸæ­£çš„é¦–æ¬¡æ„å»ºï¼ˆæ—¢æ— ç°æœ‰æ•°æ®ï¼Œä¹Ÿæ— æ–°æ„å»ºï¼‰
            if [ "$HAS_EXISTING_DATA" != "true" ] && [ "$HAS_NEW_BUILDS" != "true" ]; then
              echo "==> é¦–æ¬¡æ„å»ºä¸”æ— åŒ…æ›´æ–°ï¼Œè·³è¿‡åç»­æ­¥éª¤"
              echo "should-continue=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # å¦‚æœæœ‰ç°æœ‰æ•°æ®æˆ–æœ‰æ–°æ„å»ºï¼Œä½†æ²¡æœ‰åŒ…æ–‡ä»¶ï¼Œåˆ™æŠ¥é”™
            echo "âŒ é”™è¯¯: æ²¡æœ‰æ‰¾åˆ°ä»»ä½•åŒ…æ–‡ä»¶ï¼"
            echo ""
            echo "è¯Šæ–­ä¿¡æ¯ï¼š"
            echo "  - æœ‰ç°æœ‰æ•°æ®: $HAS_EXISTING_DATA"
            echo "  - æœ‰æ–°æ„å»º: $HAS_NEW_BUILDS"
            echo "  - å¿«ç…§æ¨¡å¼: $IS_SNAPSHOT"
            echo ""
            echo "å¯èƒ½çš„åŸå› ï¼š"
            if [ "$HAS_NEW_BUILDS" = "true" ]; then
              echo "  1. âŒ artifacts ä¸‹è½½å¤±è´¥"
            fi
            if [ "$HAS_EXISTING_DATA" = "true" ]; then
              echo "  2. âŒ release ä¸‹è½½å¤±è´¥"
            fi
            echo "  3. âŒ æ„å»ºè¿‡ç¨‹å‡ºç°é—®é¢˜"
            exit 1
          fi
          
          echo "âœ“ æ‰¾åˆ° $pkg_count ä¸ªåŒ…æ–‡ä»¶"
          
          # å¿«ç…§æ¨¡å¼ï¼šæ— è®ºæ˜¯å¦æœ‰æ–°æ„å»ºï¼Œéƒ½è¦å‘å¸ƒ
          # å¢é‡æ¨¡å¼ï¼šåªæœ‰å½“æœ‰æ–°æ„å»ºæ—¶æ‰å‘å¸ƒ
          if [ "$IS_SNAPSHOT" = "true" ]; then
            echo "==> å¿«ç…§æ¨¡å¼ï¼šå°†åˆ›å»º release"
            echo "should-continue=true" >> $GITHUB_OUTPUT
          elif [ "$HAS_NEW_BUILDS" = "true" ]; then
            echo "==> å¢é‡æ¨¡å¼ï¼šæœ‰æ–°æ„å»ºï¼Œå°†æ›´æ–° release"
            echo "should-continue=true" >> $GITHUB_OUTPUT
          else
            echo "==> å¢é‡æ¨¡å¼ï¼šæ— æ–°æ„å»ºï¼Œè·³è¿‡ release æ›´æ–°"
            echo "should-continue=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate repository database
        if: steps.verify-packages.outputs.should-continue == 'true'
        env:
          OUTPUT_DIR: ./output
        run: |
          bash scripts/generate-repo.sh
      
      - name: Upload repository artifacts
        if: steps.verify-packages.outputs.should-continue == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: repository
          path: |
            output/*.pkg.tar.zst
            output/*.db*
            output/*.files*
            output/packages.json
          retention-days: 7

  # ===========================================================================
  # Job 5: å‘å¸ƒåˆ° GitHub Releases
  # ===========================================================================
  release:
    needs: generate-repo
    name: Publish Release
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'pull_request' && 
      needs.generate-repo.outputs.should-publish == 'true'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Download repository artifacts
        uses: actions/download-artifact@v4
        with:
          name: repository
          path: output/
      
      - name: Generate release info
        id: release-info
        run: |
          echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          # ç»Ÿè®¡åŒ…æ•°é‡
          pkg_count=$(ls output/*.pkg.tar.zst 2>/dev/null | wc -l)
          echo "package_count=$pkg_count" >> $GITHUB_OUTPUT
      
      - name: Clean old package versions from latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          OUTPUT_DIR: ./output
          RELEASE_TAG: latest
        run: |
          bash scripts/clean-old-assets.sh
      
      - name: Update latest release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            **æœ€æ–°æ„å»ºçš„ SkorionOS åŒ…ä»“åº“**
            
            - æ„å»ºæ—¶é—´: ${{ steps.release-info.outputs.datetime }}
            - æäº¤: `${{ github.sha }}`
            - åŒ…æ•°é‡: ${{ steps.release-info.outputs.package_count }}
            
            ## ä½¿ç”¨æ–¹æ³•
            
            åœ¨ `/etc/pacman.conf` æ·»åŠ ï¼š
            ```ini
            [skorion]
            SigLevel = Optional TrustAll
            Server = https://github.com/${{ github.repository }}/releases/download/latest
            ```
            
            ç„¶åæ‰§è¡Œï¼š
            ```bash
            sudo pacman -Sy
            sudo pacman -S <package-name>
            ```
          files: output/*
          fail_on_unmatched_files: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create dated snapshot
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.create_snapshot)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-info.outputs.date }}
          name: Snapshot - ${{ steps.release-info.outputs.date }}
          body: |
            **å½’æ¡£å¿«ç…§**
            
            - æ„å»ºæ—¶é—´: ${{ steps.release-info.outputs.datetime }}
            - æäº¤: `${{ github.sha }}`
            - åŒ…æ•°é‡: ${{ steps.release-info.outputs.package_count }}
            
            æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨åˆ›å»ºçš„å¿«ç…§ï¼Œå¯ç”¨äºå›æ»šåˆ°ç‰¹å®šæ—¥æœŸçš„åŒ…é›†åˆã€‚
            
            ## ä½¿ç”¨æ–¹æ³•
            
            åœ¨ `/etc/pacman.conf` æ·»åŠ ï¼š
            ```ini
            [skorion]
            SigLevel = Optional TrustAll
            Server = https://github.com/${{ github.repository }}/releases/download/${{ steps.release-info.outputs.date }}
            ```
          files: output/*
          fail_on_unmatched_files: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
