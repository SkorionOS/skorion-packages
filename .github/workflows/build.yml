name: Build Packages

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: 0 0 * * *
  workflow_dispatch:
    inputs:
      create_snapshot:
        description: '创建带日期的快照 Release'
        required: false
        type: boolean
        default: false

env:
  REPO_NAME: skorion

jobs:
  # ===========================================================================
  # Job 1: 检测更新并列出需要构建的包
  # ===========================================================================
  list-packages:
    name: Detect Updates
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    outputs:
      aur-packages: ${{ steps.set-aur.outputs.matrix }}
      local-packages: ${{ steps.set-local.outputs.matrix }}
      all-packages: ${{ steps.set-all.outputs.matrix }}
      has-updates: ${{ steps.check-updates.outputs.has-updates }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          # base-devel: 包含 makepkg 等构建工具
          # git, svn, mercurial, bzr: VCS 工具（pkgver() 函数可能需要）
          # cargo, rust: Rust 项目的 pkgver() 可能需要
          # jq, curl, tar, findutils, meson: 脚本依赖
          pacman -S --noconfirm base-devel git svn mercurial bzr cargo rust jq curl tar findutils sudo meson
      
      - name: Setup builder user
        run: |
          # 创建 builder 用户（makepkg 不允许 root 运行）
          useradd -m -G wheel builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # 给予工作目录权限
          chown -R builder:builder $GITHUB_WORKSPACE
      
      - name: Check package updates
        id: check-updates
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          # 以 builder 用户运行检查脚本
          sudo -u builder bash scripts/check-updates.sh
      
      - name: List AUR packages to build
        id: set-aur
        run: |
          if [ -s updated-aur-packages.txt ]; then
            packages=$(cat updated-aur-packages.txt | jq -R -s -c 'split("\n")[:-1]')
          else
            packages="[]"
          fi
          echo "matrix=$packages" >> $GITHUB_OUTPUT
          echo "AUR packages to build: $packages"
      
      - name: List local packages to build
        id: set-local
        run: |
          if [ -s updated-local-packages.txt ]; then
            packages=$(cat updated-local-packages.txt | jq -R -s -c 'split("\n")[:-1]')
          else
            packages="[]"
          fi
          echo "matrix=$packages" >> $GITHUB_OUTPUT
          echo "Local packages to build: $packages"
      
      - name: Merge package lists
        id: set-all
        run: |
          # 合并 AUR 和本地包列表，添加类型标记
          aur_packages='${{ steps.set-aur.outputs.matrix }}'
          local_packages='${{ steps.set-local.outputs.matrix }}'
          
          # 为每个包添加类型字段（使用 -c 压缩成单行）
          all_packages=$(jq -nc \
            --argjson aur "$aur_packages" \
            --argjson local "$local_packages" \
            '($aur | map({package: ., type: "aur"})) + ($local | map({package: ., type: "local"}))')
          
          echo "matrix=$all_packages" >> $GITHUB_OUTPUT
          echo "All packages to build: $(echo "$all_packages" | jq -c '.[0:3]')... (total: $(echo "$all_packages" | jq 'length'))"

  # ===========================================================================
  # Job 2: 并行构建所有包（AUR + 本地）
  # ===========================================================================
  build-packages:
    needs: list-packages
    name: Build Packages
    runs-on: ubuntu-latest
    if: needs.list-packages.outputs.all-packages != '[]'
    container:
      image: archlinux:latest
    strategy:
      fail-fast: false
      max-parallel: 20
      matrix:
        include: ${{ fromJson(needs.list-packages.outputs.all-packages) }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup build environment
        run: |
          # 更新系统
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git sudo
          
          # 创建 builder 用户
          useradd -m -G wheel builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          
          # 安装 pikaur
          sudo -u builder bash -c "
            cd /tmp
            git clone https://aur.archlinux.org/pikaur.git
            cd pikaur
            makepkg -si --noconfirm
          "
          
          chown -R builder:builder $GITHUB_WORKSPACE
      
      - name: Build ${{ matrix.type }} package - ${{ matrix.package }}
        env:
          PACKAGE_NAME: ${{ matrix.package }}
          PACKAGE_TYPE: ${{ matrix.type }}
          OUTPUT_DIR: ${{ github.workspace }}/output
          WORK_DIR: /tmp/build
        run: |
          sudo -u builder bash -c "
            export OUTPUT_DIR='$OUTPUT_DIR'
            export WORK_DIR='$WORK_DIR'
            export GITHUB_WORKSPACE='$GITHUB_WORKSPACE'
            bash $GITHUB_WORKSPACE/scripts/build-single-package.sh '$PACKAGE_NAME' '$PACKAGE_TYPE'
          "
      
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.type }}-${{ matrix.package }}
          path: output/*.pkg.tar.zst
          if-no-files-found: error
          retention-days: 1

  # ===========================================================================
  # Job 3: 收集所有包并生成完整仓库数据库
  # ===========================================================================
  generate-repo:
    needs: [list-packages, build-packages]
    name: Generate Repository
    runs-on: ubuntu-latest
    if: always() && needs.build-packages.result != 'failure'
    container:
      image: archlinux:latest
    outputs:
      should-publish: ${{ steps.verify-packages.outputs.should-continue }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm pacman-contrib curl jq
      
      - name: Download new build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: aur-*
          merge-multiple: true
          path: output/
        continue-on-error: true
      
      - name: Download local package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: local-*
          merge-multiple: true
          path: output/
        continue-on-error: true
      
      - name: List new packages
        run: |
          echo "==> 新构建的包:"
          ls -lh output/ || echo "  无新包"
      
      - name: Download existing data from latest release
        id: download-existing
        env:
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          CREATE_SNAPSHOT: ${{ github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.create_snapshot) }}
        run: |
          echo "==> 下载 latest Release 中的现有数据"
          
          # 确保 output 目录存在
          mkdir -p output
          
          # 获取 latest release 信息
          LATEST_JSON=$(curl -s "https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/releases/tags/latest" || echo "{}")
          
          # 检查是否存在
          if echo "$LATEST_JSON" | jq -e '.message == "Not Found"' > /dev/null 2>&1; then
            echo "==> 首次构建，无现有数据"
            echo "has-existing-data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # 检查 assets 是否存在且不为空
          assets_count=$(echo "$LATEST_JSON" | jq '.assets | length // 0')
          if [ "$assets_count" -eq 0 ]; then
            echo "==> latest release 存在但没有 assets，可能是首次构建"
            echo "has-existing-data=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "has-existing-data=true" >> $GITHUB_OUTPUT
          
          if [ "$CREATE_SNAPSHOT" = "true" ]; then
            # 创建快照：下载所有包（需要完整副本）
            echo "==> 快照模式：下载所有包文件"
            echo "$LATEST_JSON" | jq -r '.assets[] | select(.name | endswith(".pkg.tar.zst")) | .browser_download_url' | while read url; do
              filename=$(basename "$url")
              
              # 跳过已存在的包（新构建优先）
              if [ -f "output/$filename" ]; then
                echo "  跳过 $filename (已有新版本)"
                continue
              fi
              
              echo "  下载 $filename"
              curl -sL "$url" -o "output/$filename"
            done
          else
            # 日常更新：只下载数据库文件（增量更新）
            echo "==> 增量模式：只下载数据库文件"
            echo "$LATEST_JSON" | jq -r '.assets[] | select(.name | test("\\.(db|files)")) | .browser_download_url' | while read url; do
              filename=$(basename "$url")
              echo "  下载 $filename"
              curl -sL "$url" -o "output/$filename"
            done
            
            # 下载 packages.json（用于版本检测）
            packages_json_url=$(echo "$LATEST_JSON" | jq -r '.assets[] | select(.name == "packages.json") | .browser_download_url')
            if [ -n "$packages_json_url" ] && [ "$packages_json_url" != "null" ]; then
              echo "  下载 packages.json"
              curl -sL "$packages_json_url" -o "output/packages.json.old" || true
            fi
          fi
          
          echo "==> 当前文件列表:"
          ls -lh output/
      
      - name: Verify package files exist
        id: verify-packages
        env:
          HAS_EXISTING_DATA: ${{ steps.download-existing.outputs.has-existing-data }}
          HAS_NEW_BUILDS: ${{ needs.list-packages.outputs.all-packages != '[]' }}
        run: |
          pkg_count=$(ls output/*.pkg.tar.zst 2>/dev/null | wc -l)
          
          if [ "$pkg_count" -eq 0 ]; then
            # 检查是否是真正的首次构建（既无现有数据，也无新构建）
            if [ "$HAS_EXISTING_DATA" != "true" ] && [ "$HAS_NEW_BUILDS" != "true" ]; then
              echo "==> 首次构建且无包更新，跳过后续步骤"
              echo "should-continue=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # 如果有现有数据或有新构建，但没有包文件，则报错
            echo "❌ 错误: 没有找到任何包文件！"
            echo ""
            echo "诊断信息："
            echo "  - 有现有数据: $HAS_EXISTING_DATA"
            echo "  - 有新构建: $HAS_NEW_BUILDS"
            echo ""
            echo "可能的原因："
            if [ "$HAS_NEW_BUILDS" = "true" ]; then
              echo "  1. ❌ artifacts 下载失败"
            fi
            if [ "$HAS_EXISTING_DATA" = "true" ]; then
              echo "  2. ❌ release 下载失败"
            fi
            echo "  3. ❌ 构建过程出现问题"
            exit 1
          fi
          
          echo "✓ 找到 $pkg_count 个包文件"
          echo "should-continue=true" >> $GITHUB_OUTPUT
      
      - name: Generate repository database
        if: steps.verify-packages.outputs.should-continue == 'true'
        env:
          OUTPUT_DIR: ./output
        run: |
          bash scripts/generate-repo.sh
      
      - name: Upload repository artifacts
        if: steps.verify-packages.outputs.should-continue == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: repository
          path: |
            output/*.pkg.tar.zst
            output/*.db*
            output/*.files*
            output/packages.json
          retention-days: 7

  # ===========================================================================
  # Job 5: 发布到 GitHub Releases
  # ===========================================================================
  release:
    needs: generate-repo
    name: Publish Release
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' && needs.generate-repo.outputs.should-publish == 'true'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4

      - name: Download repository artifacts
        uses: actions/download-artifact@v4
        with:
          name: repository
          path: output/
      
      - name: Generate release info
        id: release-info
        run: |
          echo "date=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
          echo "datetime=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          
          # 统计包数量
          pkg_count=$(ls output/*.pkg.tar.zst 2>/dev/null | wc -l)
          echo "package_count=$pkg_count" >> $GITHUB_OUTPUT
      
      - name: Clean old package versions from latest release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_FULL: ${{ github.repository }}
          OUTPUT_DIR: ./output
          RELEASE_TAG: latest
        run: |
          bash scripts/clean-old-assets.sh
      
      - name: Update latest release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            **最新构建的 SkorionOS 包仓库**
            
            - 构建时间: ${{ steps.release-info.outputs.datetime }}
            - 提交: `${{ github.sha }}`
            - 包数量: ${{ steps.release-info.outputs.package_count }}
            
            ## 使用方法
            
            在 `/etc/pacman.conf` 添加：
            ```ini
            [skorion]
            SigLevel = Optional TrustAll
            Server = https://github.com/${{ github.repository }}/releases/download/latest
            ```
            
            然后执行：
            ```bash
            sudo pacman -Sy
            sudo pacman -S <package-name>
            ```
          files: output/*
          fail_on_unmatched_files: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create dated snapshot
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.create_snapshot)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release-info.outputs.date }}
          name: Snapshot - ${{ steps.release-info.outputs.date }}
          body: |
            **归档快照**
            
            - 构建时间: ${{ steps.release-info.outputs.datetime }}
            - 提交: `${{ github.sha }}`
            - 包数量: ${{ steps.release-info.outputs.package_count }}
            
            此版本为自动创建的快照，可用于回滚到特定日期的包集合。
            
            ## 使用方法
            
            在 `/etc/pacman.conf` 添加：
            ```ini
            [skorion]
            SigLevel = Optional TrustAll
            Server = https://github.com/${{ github.repository }}/releases/download/${{ steps.release-info.outputs.date }}
            ```
          files: output/*
          fail_on_unmatched_files: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
